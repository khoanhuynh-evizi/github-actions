name: Smoke Test Manual (-s)

on:
  workflow_dispatch:
    inputs:
      suite:
        description: 'Suite name'
        required: true
        default: 'Smoke Test'
      features:
        description: 'Feature (Optional)'
        required: false
        default: ''
      featureTestCases:
        description: 'Specific testcase (Optional)'
        required: false
        default: ''
      branch:
        description: 'Test branch'
        required: true
        default: 'master'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  chrome-ubuntu:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # Checkout repositories
    # -----------------------------
    - name: Checkout workflow repo
      uses: actions/checkout@v4

    - name: Checkout WDIO repository
      uses: actions/checkout@v4
      with:
        repository: ${{ secrets.WDIO_REPOS }}
        token: ${{ secrets.WDIO_ACCESS_TOKEN }}
        ref: ${{ github.event.inputs.branch }}
        path: wdio

    # -----------------------------
    # Node & dependencies
    # -----------------------------
    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'yarn'
        cache-dependency-path: wdio/yarn.lock

    - name: Install dependencies
      run: yarn install --frozen-lockfile
      working-directory: wdio

    # -----------------------------
    # Run WDIO tests
    # -----------------------------
    - name: Run WebDriverIO Tests
      id: wdio
      uses: StarUbiquitous/command-output@v1.0.1
      with:
        run: |
          cd wdio
          yarn test:local \
            --suite="${{ github.event.inputs.suite }}" \
            --features="${{ github.event.inputs.features }}" \
            --featureTestCases="${{ github.event.inputs.featureTestCases }}"
      env:
        CAPABILITIES: chrome
        MAX_INSTANCES: 2
        R360_DASHBOARD_URL: ${{ secrets.R360_DASHBOARD_URL_S }}
      working-directory: wdio

    - name: WDIO Test Checker
      run: |
        echo "${{ steps.wdio.outputs.stdout }}" > wdio/specs-reporter.log
        if grep -E '[0-9]+\sfailed,' wdio/specs-reporter.log; then
          exit 1
        fi

    # -----------------------------
    # Allure report
    # -----------------------------
    - name: Generate Allure Report
      if: always()
      uses: simple-elf/allure-report-action@v1.13
      with:
        allure_results: wdio/reports
        allure_report: wdio/allure-report
        allure_history: wdio/allure-history

    - name: Upload HTML Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: reports-html
        path: wdio/allure-report/
        retention-days: 7

    # -----------------------------
    # Deploy to Firebase
    # -----------------------------
    - name: Prepare deploy folder
      if: always()
      run: |
        mkdir -p deploy
        cp -r wdio/allure-report/* deploy/

    - name: Create firebase config
      if: always()
      run: |
        echo '{
          "hosting": {
            "public": "deploy",
            "ignore": ["firebase.json", "**/.*", "**/node_modules/**"]
          }
        }' > firebase.json

        echo '{
          "projects": { "default": "record360-report-s" }
        }' > .firebaserc

    - name: Set up Firebase credentials
      if: always()
      run: echo '${{ secrets.L_FIREBASE_SERVICE_ACCOUNT }}' > service-account.json

    - name: Deploy Allure Report
      if: always()
      uses: w9jds/firebase-action@v13.27.0
      with:
        args: deploy --only hosting
      env:
        GOOGLE_APPLICATION_CREDENTIALS: service-account.json

    # -----------------------------
    # Parse Allure results
    # -----------------------------
    - name: Parse Allure Results
      if: always()
      run: |
        TOTAL=$(ls wdio/reports/*-result.json | wc -l)
        PASSED=$(jq '[.status=="passed"] | length' wdio/reports/*-result.json)
        FAILED=$(jq '[.status=="failed"] | length' wdio/reports/*-result.json)
        SKIPPED=$(jq '[.status=="skipped"] | length' wdio/reports/*-result.json)

        PASS_RATE=$(( PASSED * 100 / TOTAL ))

        START=$(jq '.start' wdio/reports/*-result.json | sort -n | head -1)
        STOP=$(jq '.stop' wdio/reports/*-result.json | sort -n | tail -1)

        DURATION_SEC=$(( (STOP - START) / 1000 ))

        echo "TOTAL=$TOTAL" >> $GITHUB_ENV
        echo "PASSED=$PASSED" >> $GITHUB_ENV
        echo "FAILED=$FAILED" >> $GITHUB_ENV
        echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
        echo "PASS_RATE=$PASS_RATE" >> $GITHUB_ENV
        echo "DURATION=$(date -u -d @$DURATION_SEC +%H:%M:%S)" >> $GITHUB_ENV

    # -----------------------------
    # Notify Google Chat
    # -----------------------------
    - name: Notify Google Chat
      if: always()
      env:
        TZ: Asia/Ho_Chi_Minh
      run: |
        STATUS="PASSED"
        STATUS_COLOR="#0F9D58"
        STATUS_ICON="✅"

        if [ "${{ job.status }}" != "success" ]; then
          STATUS="FAILED"
          STATUS_COLOR="#DB4437"
          STATUS_ICON="❌"
        fi

        export STATUS STATUS_COLOR STATUS_ICON PASS_RATE

        envsubst < .github/googlechat/google-chat-card.json > payload.json

        curl -X POST "${{ secrets.GCHAT_WEBHOOK }}" \
          -H "Content-Type: application/json" \
          -d @payload.json
