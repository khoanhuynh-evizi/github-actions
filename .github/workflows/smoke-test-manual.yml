name: Smoke Test Manual (-s)

on:
  workflow_dispatch:
    inputs:
      suite:
        description: 'Suite name'
        required: true
        default: 'Smoke Test'
      features:
        description: 'Feature (Optional)'
        required: false
        default: ''
      featureTestCases:
        description: 'Specific testcase (Optional)'
        required: false
        default: ''
      branch:
        description: 'Test branch'
        required: true
        default: 'master'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  chrome-ubuntu:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout WDIO Repository
      uses: actions/checkout@v3
      with:
        repository: ${{ secrets.WDIO_REPOS }}
        token: ${{ secrets.WDIO_ACCESS_TOKEN }}
        ref: ${{ github.event.inputs.branch }}

    - name: Use Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'yarn'
        cache-dependency-path: yarn.lock

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Run WebDriverIO Tests
      uses: StarUbiquitous/command-output@v1.0.1
      id: wdio
      with:
        run: |
          yarn test:local \
            --suite="${{ github.event.inputs.suite }}" \
            --features="${{ github.event.inputs.features }}" \
            --featureTestCases="${{ github.event.inputs.featureTestCases }}"
      env:
        CAPABILITIES: chrome
        MAX_INSTANCES: 2
        R360_DASHBOARD_URL: ${{ secrets.R360_DASHBOARD_URL_S }}

    - name: WDIO Test Checker
      timeout-minutes: 330
      run: |
        cat > specs-reporter.log <<EOL
        ${{ steps.wdio.outputs.stdout }}
        EOL
        
        if [ ! -z "$(egrep '[0-9]+\sfailed,\s' specs-reporter.log)" ]; then
          exit 1
        fi
    - name: Build Google Chat Card
      if: always()
      id: chat
      shell: bash
      run: |
        LOG="${{ steps.wdio.outputs.stdout }}"

        PASSED=$(echo "$LOG" | grep -oE '[0-9]+\s+passing' | grep -oE '[0-9]+' | head -1 || echo 0)
        FAILED=$(echo "$LOG" | grep -oE '[0-9]+\s+failing' | grep -oE '[0-9]+' | head -1 || echo 0)
        SKIPPED=$(echo "$LOG" | grep -oE '[0-9]+\s+skipped' | grep -oE '[0-9]+' | head -1 || echo 0)

        if [ "${{ job.status }}" = "success" ]; then
          STATUS="PASSED"
          COLOR="#0F9D58"
        else
          STATUS="FAILED"
          COLOR="#D93025"
        fi

        echo "payload<<EOF" >> "$GITHUB_OUTPUT"
        cat <<EOF >> "$GITHUB_OUTPUT"
        {
          "cardsV2": [
            {
              "cardId": "wdio-smoke-report",
              "card": {
                "header": {
                  "title": "ðŸ”¥ WebdriverIO Smoke Test Report",
                  "subtitle": "$(date '+%Y-%m-%d %H:%M:%S')"
                },
                "sections": [
                  {
                    "widgets": [
                      {
                        "textParagraph": {
                          "text": "<tt>Status&nbsp;&nbsp;&nbsp;:</tt> <font color=\"$COLOR\"><b>$STATUS</b></font><br/>\
          <tt>Suite&nbsp;&nbsp;&nbsp;&nbsp;:</tt> ${{ github.event.inputs.suite }}<br/>\
          <tt>Branch&nbsp;&nbsp;:</tt> ${{ github.event.inputs.branch }}<br/>\
          <tt>Commit&nbsp;&nbsp;:</tt> <tt>${GITHUB_SHA::8}</tt>"
                        }
                      }
                    ]
                  },
                  {
                    "widgets": [
                      {
                        "textParagraph": {
                          "text": "<b>Results</b><br/>\
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br/>\
          <tt>Passed&nbsp;&nbsp;&nbsp;:</tt> $PASSED<br/>\
          <tt>Failed&nbsp;&nbsp;&nbsp;:</tt> $FAILED<br/>\
          <tt>Skipped&nbsp;&nbsp;:</tt> $SKIPPED"
                        }
                      }
                    ]
                  },
                  {
                    "widgets": [
                      {
                        "buttons": [
                          {
                            "text": "ðŸ“„ View CI Run / Allure",
                            "onClick": {
                              "openLink": {
                                "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            }
          ]
        }
        EOF

    # --------------------------------------------------
    # ðŸ“¤ Send Google Chat
    # --------------------------------------------------
    - name: Send Google Chat Notification
      if: always()
      env:
        GCHAT_WEBHOOK: ${{ secrets.GCHAT_WEBHOOK }}
      run: |
        curl -s -X POST "$GCHAT_WEBHOOK" \
          -H "Content-Type: application/json" \
          -d '${{ steps.chat.outputs.payload }}'
    
    - name: Generate Allure Report
      if: always()
      uses: simple-elf/allure-report-action@v1.13
      with:
        allure_results: reports
        allure_report: allure-report
        allure_history: allure-history
    - name: Upload HTML Report
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: reports-html
        path: allure-report/
        retention-days: 7

    - name: Upload Raw Allure Results
      if: success() || failure()
      uses: actions/upload-artifact@v4
      with:
        name: reports-allure
        path: reports/
        retention-days: 7     

    - name: Prepare dated report & create deploy folder
      if: always()
      run: |
        mkdir -p deploy
        cp -r allure-report/* deploy/
  
    - name: Create firebase.json & .firebaserc
      if: always()
      run: |
        echo '{
          "hosting": {
            "public": "deploy",
            "ignore": ["firebase.json", "**/.*", "**/node_modules/**"]
          }
        }' > firebase.json
        echo '{
          "projects": {
            "default": "record360-report-s"
          }
        }' > .firebaserc

    - name: Set up Firebase credentials
      if: always()
      run: echo '${{ secrets.L_FIREBASE_SERVICE_ACCOUNT }}' > $GITHUB_WORKSPACE/service-account.json

    - name: Deploy Allure Report to Firebase Hosting
      if: always()
      uses: w9jds/firebase-action@v13.27.0
      with:
        args: deploy --only hosting --project record360-report-s
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/service-account.json
